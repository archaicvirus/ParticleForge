-- title:   Particle Forge demo
-- author:  ArchaicVirus
-- desc:    example implementation demo
-- site:    github.com/ArchaicVirus
-- license: GPLV3
-- version: 0.1
-- script:  lua

floor, ceil, rnd, abs, rad, deg, cos, sin, min, max =  math.floor, math.ceil, math.random, math.abs, math.rad, math.deg, math.cos, math.sin, math.min, math.max
GRID_WIDTH, GRID_HEIGHT = 240, 136
require("classes/vec2D")
grid = vec2(0, 0)
require("saves/particle_defs")
require("classes/particles")
require("classes/utils")
TICK = 0
LAST_FRAME_TIME = time()
EMITTER = {}

function setup_emitter()
	EMITTER = deep_copy(EMITTER_PRESET[2])
	EMITTER.particle_systems = {}

	for k, v in ipairs(EMITTER_PRESET[2].particle_systems) do
		v.name = v.name
		v.settings = unpack_particle_settings(v)
		v.visibility = v.settings.visibility or true
		v.settings.bounds = { x = grid.x, y = grid.y, w = GRID_WIDTH, h = GRID_HEIGHT - 1 }
		v.particles = {
			fg = {},
			bg = {},
		}
		v.kill = false
		table.insert(EMITTER.particle_systems, v)
	end
	EMITTER_POSITION = vec2(120, 64)
end

function update_particles(dt)
	for k, v in ipairs(EMITTER.particle_systems) do
		--SORT PARTICLES BY AGE
		-- table.sort(v.particles.fg, function(a, b)
		-- 	return a.age > b.age
		-- end)
		-- table.sort(v.particles.bg, function(a, b)
		-- 	return a.age < b.age
		-- end)

		for i, p in ipairs(v.particles.fg) do
			if not p:isAlive() then
				table.remove(v.particles.fg, i)
			else
				p:update(dt)
			end
		end
		for i, p in ipairs(v.particles.bg) do
			if not p:isAlive() then
				table.remove(v.particles.bg, i)
			else
				p:update(dt)
			end
		end
	end

	--SPAWN NEW PARTICLES-------------------------------------------------
	if #EMITTER.particle_systems > 0 then
		for k, v in ipairs(EMITTER.particle_systems) do
			if v.settings.spawn_rate.val > 0 and TICK % v.settings.spawn_rate.val == 0 then
				local parts = new_active_particle(v)
				if parts then
					for i = 1, #parts do
						table.insert((rnd() > 0.5 and v.particles.fg) or v.particles.bg, parts[i])
					end
				end
			end
		end
	end
end

function draw_particles()
	--SWAP TO BACKGROUND LAYER------------------------------------------
	vbank(0)
	cls()

	--DRAW BACKGROUND PARTICLES------------------------------------------
	for index, particle_system in ipairs(EMITTER.particle_systems) do
		if #particle_system.particles.bg > 0 then
			for i, particle in ipairs(particle_system.particles.bg) do
				particle:draw(dt)
			end
		end
	end

	--SWAP TO FOREGROUND LAYER------------------------------------------
	vbank(1)
	cls()

	--DRAW FOREGROUND PARTICLES------------------------------------------
	for _, particle_system in ipairs(EMITTER.particle_systems) do
		if #particle_system.particles.fg > 0 then
			for k, particle in ipairs(particle_system.particles.fg) do
				particle:draw(dt)
			end
		end
	end
end

setup_emitter()

function TIC()
	local dt = time() - LAST_FRAME_TIME
	LAST_FRAME_TIME = time()
	cls(1)
	update_cursor_state(dt)
	update_particles(dt)
	draw_particles()
	TICK = TICK + 1
end

-- <TILES>
-- 166:0000000000000000040000400340043040340300043434040434343000434300
-- 176:0333300034444300455544303344554304333453000043430000003400000000
-- 182:0000000000060000006760000006000000040000000400000004000000040000
-- 183:0000000000000300000004000000400003004000003043000030400000304000
-- 192:0f0ff0e000f33f000f3213f00f3113f000f33f000f0ff0e00000300000003430
-- 193:2022020002112000212c120021cc120002112000202202000003004000430434
-- 194:0000000040330000030030003000030039300300034003400000030000003000
-- 195:0000000000000000000000000000000000403300000300300030003000305430
-- 196:00000f0f000000f304000f3a30300f3c000300f300030f0f0003034300003403
-- 197:f0f000004f000030c4f00304c4f004004f003000f0f340004343000040300000
-- 198:00300004003f040400f1f404004f004040030304040303030404040303030404
-- 199:000000000000000000400000004000404003400f04f340030f9f340300f30434
-- 208:0000040000000300000034000004300000003000000434000043434004303034
-- 209:0003433404003440434030004334340004403000000030000000340000043000
-- 210:0003000004030000003000000030000000300000000300000043000000030000
-- 211:0430430000300400003000000003040000003000000030000043000000030000
-- 212:000000000000000000400000004000404003400f04f340030f9f340300f30434
-- 213:000000000000000000000000f00430008f430000f03000004030000030400000
-- 214:0000c000000cbc000000c0000000300000003000000040000000400000004000
-- 215:000f000000f7f000000f00000043000000030000000340000003000000030000
-- 224:0000000000000000000eee0000eeeed00eeeedd00eeeded00eeeedd0edeeed00
-- 225:000de00000eede00000eede00000eee00000eeee0000eeed000edeed00eedeed
-- 226:000000000000000000000eee0000eeee000eeeee000eeeee000eeede000eeede
-- 227:0000000000000000edd00000dedd0000ededd000eeeed000edede000eeeed000
-- 228:0000000000000000000eee0000eeeed00eeeedd00eeeded00eededd000eede00
-- 229:0000b000000bcb000000b0000000400000004300000040000003400000004000
-- 230:0000c000000cbc000000c0000000c0000000cb000000b000000cb0000000b000
-- 240:eedeed00eededed0eeeeede00eeeded00eeeedd00eeeddd00eedede000eede00
-- 241:0eedeeed0eeeeeedeeeeeeddeeeeededeeeeded00eededd00eeeded00eeddd00
-- 242:000eedee0000deee000eedde000eeeed000eeeee000eeeee0000eeed00000eee
-- 243:eeeddd00eededed0eeeeededeeeededddeeeededdeeeeed0edeeedd0eededd00
-- 244:0000000000000000000000000000000000ee00000eeed0000eede00000ded000
-- 245:00000000000000000000000000000000000ed00000eded0000eeded0000eede0
-- 246:0000000000000000000b000000bcb000000b0000000000000000000000000000
-- 247:0000000000000000000c000000cbc000000c0000000000000000000000000000
-- </TILES>

-- <SPRITES>
-- 000:006677000600007060e000076000000760000007600000070600007000666700
-- 001:00b0000000cb00000bccc0000cccc000bccccc00ccbccc00bccccc000bccc000
-- 002:0aa09900aaaa9990aaa999900aaa990000a99000000a00000000000000000000
-- 003:0880088088c88c888cccccc88cccccc88cccccc808cccc80008cc80000088000
-- 004:000000000cc0cc00ccccccc0ccccccc00ccccc0000ccc000000c000000000000
-- 016:00b0000000cb00000bccc0000cccc000bccccc00ccbccc00bccccc000bccc000
-- 017:0cc0cc00ccccccc0ccccccc00ccccc0000ccc000000c00000000000000000000
-- 018:003344000300004030f000043000000430000004300000040300004000333400
-- 019:00ccbb000c0000b0c0b0000bc000000bc000000bc000000b0c0000b000ccbb00
-- 020:0888888888cc8cc88ccccccc8ccccccc88ccccc8088ccc880088c88000088800
-- 021:0000000080000000800000008000000080000000000000000000000000000000
-- 032:0088088008cb8bc88cbcbbbb8ccbcbbb08ccbcb8008ccb800008c80000008000
-- 033:00cbcb000cbcbbc0bccbbbbcccbcbbbccbcbbbbbbcccbcbb0bcbccb000bccb00
-- 034:00bcbc000bccccb0cbbccccbbbcbcccbbcbccccccbbbcbcc0cbcbbc000cbbc00
-- 224:4040000024200000424000002020000000000000000000000000000000000000
-- 225:444000002c200000020000000000000000000000000000000000000000000000
-- 226:000000000044000004cc400002cc200000220000000000000000000000000000
-- 227:0000000000220000024420000244200000220000000000000000000000000000
-- 240:0000000000000000000420000000420000042000000000000000000000000000
-- 241:0000000000000000000240000000240000024000000000000000000000000000
-- 242:0000000000040000000c4000000cc400000cc200000c20000002000000000000
-- 243:000000000400040002400c0000240c0000020c0004444c000222220000000000
-- 244:0000000000040000004c4000042c2400020c0200000c00000002000000000000
-- 245:0000000000040000000c0000040c0400024c4200002c20000002000000000000
-- 246:0201020110000000000000022000000000000001100000000000000220102010
-- 247:00000000040400004c4c40002c2c20004c4c40002c2c20000202000000000000
-- 248:0000000044440000222200004444000022220000000000000000000000000000
-- 249:0000000044444000222220004444400022222000444440002222200000000000
-- 250:0000000004040400020202000404040002020200040404000202020000000000
-- 251:f0f0f0f000000000f000000000000000f000000000000000f000000000000000
-- 252:00000000044444004cc2cc40cc222cc0cc424cc02cc4cc200222220000000000
-- 253:022200002ccc0000cccc0000cccc0000cccc0000cccc00004ccc000004440000
-- 254:d333333ec0000002c0000002c0000002c0000002c0000002c0000002e777777d
-- 255:00000002000000ce00000c020000c002000c000200c000020c0000022777777d
-- </SPRITES>

-- <WAVES>
-- 000:00000000ffffffff00000000ffffffff
-- 001:0123456789abcdeffedcba9876543210
-- 002:0123456789abcdef0123456789abcdef
-- </WAVES>

-- <SFX>
-- 000:000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000304000000000
-- </SFX>

-- <TRACKS>
-- 000:100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- </TRACKS>

-- <PALETTE>
-- 000:1d1d20f9801dfed83d80c71f5e7c16169c9c4c7dca20387d141414c74ebdf38baa8d4820b02e26474f618d8d89d6d6d2
-- 001:1d1d20f9801dfed83d80c71f5e7c16169c9c4c7dca20387d141414c74ebdf38baa8d4820b02e26474f618d8d89d6d6d2
-- </PALETTE>

-- <PALETTE1>
-- 000:1d1d20ba5d1db6892844690c203810185050346d912424441414147530619d557d59300c611c10242c2c5d5d5d999595
-- 001:1d1d20f9801dfed83d80c71f5e7c16169c9c4c7dca20387d141414c74ebdf38baa8d4820b02e26474f528d8d89d6d6d2
-- </PALETTE1>

-- <PALETTE2>
-- 000:1d1d20ba5d1db6892844690c203810143c3c346d912424441414147530619d557d59300c611c10242c2c5d5d5d999595
-- 001:1d1d20f9801dfed83d80c71f5e7c16169c9c4c7dca20387d141414c74ebdf38baa8d4820b02e26474f528d8d89d6d6d2
-- </PALETTE2>

-- <PALETTE3>
-- 000:1d1d20ba5d1db6892844690c203810185050346d912424441414147530619d557d59300c611c10242c2c5d5d5d999595
-- 001:1d1d20f9801dfed83d80c71f5e7c16169c9c4c7dca20387d141414c74ebdf38baa8d4820b02e26474f528d8d89d6d6d2
-- </PALETTE3>

-- <PALETTE4>
-- 000:1d1d20ba5d1db6892844690c203810185050346d912424441414147530619d557d59300c611c10242c2c5d5d5d999595
-- 001:1d1d20f9801dfed83d80c71f5e7c16169c9c4c7dca20387d141414c74ebdf38baa8d4820b02e26474f528d8d89d6d6d2
-- </PALETTE4>

-- <PALETTE5>
-- 000:1d1d20ba5d1db6892844690c203810185050346d912424441414147530619d557d59300c611c10242c2c5d5d5d999595
-- 001:1d1d20f9801dfed83d80c71f5e7c16169c9c4c7dca20387d141414c74ebdf38baa8d4820b02e26474f528d8d89d6d6d2
-- </PALETTE5>

-- <PALETTE6>
-- 000:1d1d20ba5d1db6892844690c203810185050346d912424441414147530619d557d59300c611c10242c2c5d5d5d999595
-- 001:1d1d20f9801dfed83d80c71f5e7c16169c9c4c7dca20387d141414c74ebdf38baa8d4820b02e26474f528d8d89d6d6d2
-- </PALETTE6>

-- <PALETTE7>
-- 000:1d1d20ba5d1db6892844690c203810185050346d912424441414147530619d557d59300c611c10242c2c5d5d5d999595
-- 001:1d1d20f9801dfed83d80c71f5e7c16169c9c4c7dca20387d141414c74ebdf38baa8d4820b02e26474f528d8d89d6d6d2
-- </PALETTE7>
